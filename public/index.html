<h1>Barter_Hub/listing</h1>
<h3 id="itemCount">ITEMS LISTED: 0</h3>

<a
  href="register.html"
  style="
    display: block;
    margin-bottom: 1.5rem;
    text-align: center;
    color: #4f8ef7;
    text-decoration: none;
  "
  >Create an account</a
>

<form id="loginForm" style="margin-bottom: 2rem">
  <input
    type="text"
    name="username"
    placeholder="Username"
    required
    autocomplete="username"
  />
  <input
    type="password"
    name="password"
    placeholder="Password"
    required
    autocomplete="current-password"
  />
  <button type="submit">Login</button>
</form>

<form id="tradeForm" style="display: none">
  <input type="text" name="have" placeholder="I have..." required />
  <input type="text" name="want" placeholder="I want..." required />
  <input type="email" name="email" placeholder="Contact email..." required />
  <input type="url" name="image" placeholder="Image URL (optional)" />
  <button type="submit">List Item</button>
</form>
<button id="logoutBtn" style="display: none; margin-bottom: 2rem">
  Logout
</button>

<h2>Current Listings</h2>
<ul id="tradeList"></ul>

<style>
  body {
    font-family: "VCR OSD Mono", monospace;
    margin: 3rem auto;
    max-width: 600px;
    background: #f9f9f9;
    color: #222;
  }

  h1 {
    font-family: "VCR OSD Mono", monospace;
    font-size: 2rem;
    color: #333;
    text-align: center;
  }

  #itemCount {
    font-family: "VCR OSD Mono", monospace;
    font-size: 1.5rem;
    letter-spacing: 2px;
    color: #000000;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    padding: 0.5rem 1rem;
    display: inline-block;
    border-radius: 4px;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 2rem;
    background: #fff;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  input,
  button {
    padding: 0.7rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    transition: 0.2s ease;
  }

  input:focus {
    border-color: #4f8ef7;
    outline: none;
  }

  button {
    background: #4f8ef7;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  button:hover {
    background: #3d76d0;
  }

  h2 {
    margin-top: 2rem;
    font-size: 1.4rem;
    color: #444;
    border-bottom: 1px solid #ddd;
    padding-bottom: 0.5rem;
  }

  ul#tradeList {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  ul#tradeList li {
    background: #fff;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  ul#tradeList li strong {
    color: #2c3e50;
  }

  ul#tradeList li em {
    color: #777;
  }
</style>

<script async>
  const loginForm = document.getElementById("loginForm");
  const tradeForm = document.getElementById("tradeForm");
  const tradeList = document.getElementById("tradeList");
  const logoutBtn = document.getElementById("logoutBtn");

  loginForm.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(loginForm);
    const payload = {
      username: formData.get("username"),
      password: formData.get("password"),
    };
    try {
      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        credentials: "same-origin",
      });
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || "Login failed");
      }
      // Get the real current user from the server (robust, not just trusting the input)
      const meRes = await fetch("/api/me", { credentials: "same-origin" });
      if (meRes.ok) {
        const me = await meRes.json();
        window.currentUser = me.username;
      } else {
        window.currentUser = payload.username;
      }
      loginForm.style.display = "none";
      tradeForm.style.display = "flex";
      logoutBtn.style.display = "inline-block";
      loadTrades();
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  };

  logoutBtn.onclick = async () => {
    await fetch("/logout", { method: "POST" });
    loginForm.style.display = "flex";
    tradeForm.style.display = "none";
    logoutBtn.style.display = "none";
    tradeList.innerHTML = "<li>Please login to view trades.</li>";
    document.getElementById("itemCount").textContent = "ITEMS LISTED: 0";
  };

  tradeForm.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(tradeForm);
    const payload = {
      have: formData.get("have"),
      want: formData.get("want"),
      email: formData.get("email"),
      image: formData.get("image"),
    };
    try {
      const res = await fetch("/api/trades", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        credentials: "same-origin",
      });
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || "Failed to submit trade.");
      }
      tradeForm.reset();
      loadTrades();
    } catch (err) {
      alert("Error posting trade: " + err.message);
    }
  };
  async function loadTrades() {
    try {
      const res = await fetch("/api/trades", { credentials: "same-origin" });
      if (res.status === 401) {
        loginForm.style.display = "flex";
        tradeForm.style.display = "none";
        logoutBtn.style.display = "none";
        tradeList.innerHTML = "<li>Please login to view trades.</li>";
        document.getElementById("itemCount").textContent = "ITEMS LISTED: 0";
        return;
      }
      const trades = await res.json();
      document.getElementById(
        "itemCount"
      ).textContent = `ITEMS-LISTED: ${trades.length}`;
      tradeForm.style.display = "flex";
      logoutBtn.style.display = "inline-block";
      loginForm.style.display = "none";
      // Always get the current user from the server if possible
      let currentUser = window.currentUser || null;
      try {
        const meRes = await fetch("/api/me", { credentials: "same-origin" });
        if (meRes.ok) {
          const me = await meRes.json();
          currentUser = me.username;
          window.currentUser = me.username;
        }
      } catch {}

      tradeList.innerHTML = trades
        .map((t, i) => {
          let bidBtn = "";
          let bidsHtml = "";
          // Show BID button for any logged-in user (including owner), and only if they haven't already placed a pending bid ON THIS TRADE
          if (currentUser) {
            const hasPendingBid =
              t.bids &&
              t.bids.some(
                (b) => b.bidder === currentUser && b.status === "pending"
              );
            if (!hasPendingBid) {
              bidBtn = `<button class="bid-btn" data-index="${i}">BID</button>`;
            } else {
              bidBtn = `<span style='color:#888;font-size:0.95em;'>(Bid placed)</span>`;
            }
          }

          // Show all bids for this trade
          if (t.bids && t.bids.length > 0) {
            bidsHtml =
              `<div style='margin-top:0.5rem;'><strong>Bids:</strong><ul style='padding-left:1.2em;'>` +
              t.bids
                .map((b, j) => {
                  let controls = "";
                  // Only owner can accept/reject pending bids
                  if (
                    currentUser &&
                    t.owner === currentUser &&
                    b.status === "pending"
                  ) {
                    controls = ` <button class='accept-bid' data-index='${i}' data-bid='${j}'>Accept</button> <button class='reject-bid' data-index='${i}' data-bid='${j}'>Reject</button>`;
                  }
                  // Highlight accepted/rejected for the bidder
                  let statusLabel = b.status;
                  if (b.status === "accepted") {
                    statusLabel = `<span style='color:green;font-weight:bold;'>accepted</span>`;
                  } else if (b.status === "rejected") {
                    statusLabel = `<span style='color:#b00;font-weight:bold;'>rejected</span>`;
                  } else {
                    statusLabel = `<span style='color:#888;'>pending</span>`;
                  }
                  return `<li><b>${b.bidder}</b>: ${b.message} [${statusLabel}]${controls}</li>`;
                })
                .join("") +
              `</ul></div>`;
          }

          return (
            `<li>` +
            (t.image
              ? `<img src="${t.image}" alt="item image" style="max-width:80px;max-height:80px;margin-right:1rem;border-radius:6px;vertical-align:middle;" />`
              : "") +
            `<div><strong>${t.have}</strong> ➡️ <em>${t.want}</em><br><small>Owner: ${t.owner}</small> ${bidBtn} ${bidsHtml}</div></li>`
          );
        })
        .join("");

      // Add event listeners for bid buttons
      document.querySelectorAll(".bid-btn").forEach((btn) => {
        btn.onclick = function () {
          const index = this.getAttribute("data-index");
          const message = prompt("Enter your bid message:");
          if (!message) return;
          fetch(`/api/trades/${index}/bid`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
            credentials: "same-origin",
          })
            .then((r) => {
              if (!r.ok)
                return r.json().then((e) => {
                  throw new Error(e.error || "Bid failed");
                });
              loadTrades();
            })
            .catch((e) => alert(e.message));
        };
      });
      // Accept/reject bid buttons
      document.querySelectorAll(".accept-bid").forEach((btn) => {
        btn.onclick = function () {
          const index = this.getAttribute("data-index");
          const bid = this.getAttribute("data-bid");
          fetch(`/api/trades/${index}/bid/${bid}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "accept" }),
            credentials: "same-origin",
          })
            .then((r) => {
              if (!r.ok)
                return r.json().then((e) => {
                  throw new Error(e.error || "Accept failed");
                });
              loadTrades();
            })
            .catch((e) => alert(e.message));
        };
      });
      document.querySelectorAll(".reject-bid").forEach((btn) => {
        btn.onclick = function () {
          const index = this.getAttribute("data-index");
          const bid = this.getAttribute("data-bid");
          fetch(`/api/trades/${index}/bid/${bid}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "reject" }),
            credentials: "same-origin",
          })
            .then((r) => {
              if (!r.ok)
                return r.json().then((e) => {
                  throw new Error(e.error || "Reject failed");
                });
              loadTrades();
            })
            .catch((e) => alert(e.message));
        };
      });
    } catch (error) {
      tradeList.innerHTML = "<li>Error loading Trades</li>";
    }
  }

  // Check auth on page load
  loadTrades();
</script>
